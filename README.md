# postgresrelay

## Table of Contents

* [Overview](#overview)
* [Purpose](#purpose)
* [Requirements](#requirements)
* [Usage](#usage)
* [Building and running image](#building-and-running-image)
* [Environment variables](#environment-variables)
* [Caveats](#caveats)

## Overview

`PostgreSQL Relay` is a proxy server for PostgreSQL with query logging capability that forwards packets from client software to a PostgreSQL instance set with functionality of logging queries.

## Purpose

The application aims to seamlessly proxy connections from clients to a PostgreSQL instance and writes clients' queries down into a logfile. The application does not make any attempt to change or manipulate data and passes packets received from clients to the PostgreSQL instance intact. Before being written to the logfile, the queries are filtered removing ancillary ones that are generated by client software and oftentimes are not meaningful. The queries are written in [ProxySQL](https://github.com/sysown/proxysql/wiki/Query-Logging#json-format-logging) format in order to make them compatible with the [Query Publisher](https://github.com/constantine-kutenko/query-ublisher).

## Requirements

* Python 3.6.x
* Docker (of any version)

## Usage

As the application is designed to be run in container, in order to run it one should set the respective [environment variables](#environment-variables) to override its defaults:

```bash
    LISTEN_ADDR="127.0.0.1" \
    LISTEN_PORT="8090" \
    REMOTE_ADDR="postgres-instance.example.com" \
    REMOTE_PORT="5432" \
    python3 ./src/app.py
```

The following example demonstrates how to configure a native PostgreSQL client `psql` to send data through the relay. It is important to disable SSL on client side in order to get queries logged. The support for SSL/TLS is envisaged in further releases.

```bash
    PGPASSWORD='database_password' \
    PGSSLMODE='disable' \
    psql -h 127.0.0.1 -p 8090 -U <database_user> -d <database_name>
```

In case a Java-based client software such as DataGrip/DBeaver is used, the JDBC driver should properly be configured to explicitly disable SSL and allow connections:

```javascript
    jdbc:postgresql://127.0.0.1:5433/<database_name>?verifyServerCertificate=false&useSSL=false&sslmode=disable
```

For more information about usage SSL/TLS see [Caveats](#caveats)

## Building and running image

To build an image run following command in repository root path:

```bash
    docker build \
        --pull \
        --tag postgresrelay:0.0.1 \
        -f docker/Dockerfile .
```

To run the image (with defaults) use:

```bash
    docker run \
        --rm \
        --name postgresrelay \
        --hostname postgresrelay \
        --publish 8090:8090 \
        -v ${PWD}/logs/:/var/log/postgresrelay/ \
        -it postgresrelay:0.0.1
```

## Environment variables

Environment variables is the main mechanism of manipulating application settings inside a container.

| Variable | Default value | Description |
| --- | --- | --- |
| LISTEN_ADDR | `0.0.0.0` | Specifies the IPv4 address to listen on |
| LISTEN_PORT | `8090` | Specifies the TCP port to listen on |
| REMOTE_ADDR | `127.0.0.1` | Specifies the IPv4 address of a PostgreSQL instance to which requests will be redirected |
| REMOTE_PORT | `5432` | Specifies TCP port for a remote PostgreSQL instance |
| QUERY_LOG | `/var/log/postgresrelay/queries.log` | Specifies the path to a logfile where clients' queries are written |
| CONFIG_FILE | `/etc/postgresrelay/config.yaml` | Specifies the full path to the configuration file |
| LOG_LEVEL | info | Specifies level of logging of event that will be sent to `stdout`. Acceptable values are `info` and `debug` |

## Caveats

As the application is designed to analyse PostgreSQL message headers and does not currently support encryption, it is crucial that the traffic between clients and the PostgreSQL instance goes unencrypted. This may potentially impose some security risk that can be overcome by implementing a bastion server (an SSH jump host).

More information about PostgreSQL protocol and message types can be obtained form the official documentation:

* [PostgreSQL protocol](https://www.postgresql.org/docs/7.2/protocol-protocol.html)
* [PostgreSQL Message Formats](https://www.postgresql.org/docs/7.2/protocol-message-formats.html)
